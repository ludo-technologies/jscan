#!/usr/bin/env node

const { spawn } = require("child_process");

const platformPackages = {
  "darwin-arm64": "jscan-darwin-arm64",
  "linux-x64": "jscan-linux-x64",
  "linux-arm64": "jscan-linux-arm64",
  "win32-x64": "jscan-windows-x64",
};

const key = `${process.platform}-${process.arch}`;
const pkg = platformPackages[key];

if (!pkg) {
  console.error(
    `Unsupported platform: ${process.platform}-${process.arch}\n` +
      `jscan supports: ${Object.keys(platformPackages).join(", ")}`
  );
  process.exit(1);
}

const ext = process.platform === "win32" ? ".exe" : "";
let binaryPath;
try {
  binaryPath = require.resolve(`${pkg}/bin/jscan${ext}`);
} catch {
  console.error(
    `Could not find the jscan binary for ${process.platform}-${process.arch}.\n` +
      `The platform package "${pkg}" may not be installed.\n` +
      `Try reinstalling: npm install jscan`
  );
  process.exit(1);
}

const child = spawn(binaryPath, process.argv.slice(2), {
  stdio: "inherit",
});

child.on("error", (err) => {
  console.error(`Failed to start jscan: ${err.message}`);
  process.exit(1);
});

child.on("close", (code) => {
  process.exit(code ?? 0);
});
